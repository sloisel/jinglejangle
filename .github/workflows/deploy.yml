name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Build web
        run: flutter build web --base-href=/jinglejangle/ --pwa-strategy=offline-first

      - name: Patch service worker to precache all assets in batches
        run: |
          node -e "
          const fs = require('fs');
          const file = 'build/web/flutter_service_worker.js';
          let content = fs.readFileSync(file, 'utf8');

          // Replace the install handler to cache all RESOURCES in batches
          const newInstall = \`
          self.addEventListener('install', (event) => {
            self.skipWaiting();
            return event.waitUntil((async () => {
              const cache = await caches.open(TEMP);
              const keys = Object.keys(RESOURCES);
              const batchSize = 20;
              for (let i = 0; i < keys.length; i += batchSize) {
                const batch = keys.slice(i, i + batchSize);
                await Promise.all(batch.map(async (key) => {
                  try {
                    const req = new Request(key, {cache: 'reload'});
                    const resp = await fetch(req);
                    if (resp.ok) await cache.put(req, resp);
                  } catch (e) { console.warn('Failed to cache:', key, e); }
                }));
              }
            })());
          });\`;

          content = content.replace(
            /self\\.addEventListener\\(\"install\"[\\s\\S]*?\\}\\);/,
            newInstall
          );

          // Fix fetch handler: strip base-href prefix from key
          content = content.replace(
            'var key = event.request.url.substring(origin.length + 1);',
            \"var key = event.request.url.substring(origin.length + 1);\\n  if (key.startsWith('jinglejangle/')) key = key.substring('jinglejangle/'.length);\"
          );

          fs.writeFileSync(file, content);
          console.log('Patched service worker with batched caching and base-href fix');

          // Also patch flutter_bootstrap.js to use local CanvasKit instead of CDN
          const bootstrap = 'build/web/flutter_bootstrap.js';
          let bsContent = fs.readFileSync(bootstrap, 'utf8');
          bsContent = bsContent.replace(
            '_flutter.loader.load({',
            '_flutter.loader.load({ config: { canvasKitBaseUrl: \"canvaskit/\", fontFallbackBaseUrl: \"\" },'
          );
          fs.writeFileSync(bootstrap, bsContent);
          console.log('Patched flutter_bootstrap.js to use local CanvasKit');
          "

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/web

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
